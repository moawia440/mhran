<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta name="theme-color" content="#0B0820" />
    <title>ุงูุฃุฏูุงุช ุงููุฏุฑุณูุฉ</title>

    <!-- PWA -->
    <link rel="manifest" href="manifest.webmanifest" />
    <link rel="apple-touch-icon" href="assets/icons/icon-192.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />

    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <!-- Header -->
    <header class="header" id="top">
      <div class="container header__row">
        <a class="brand" href="index.html#top" aria-label="ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ">
          <span class="brand__logo" aria-hidden="true"></span>
          <span class="brand__txt">
            <strong>ูุคุณุณุฉ ุงููุฑุฏูุณ</strong>
            <em>ููุทุจุงุนุฉ ูุงูุชูุฒูุน</em>
          </span>
        </a>

        <nav class="nav" aria-label="ุงููุงุฆูุฉ">
          <a href="index.html#releases">ุงูุฅุตุฏุงุฑุงุช</a>
          <a href="index.html#videos">ููุฏูู</a>
          <a href="index.html#contact">ุชูุงุตู</a>
          <a href="school.html" aria-current="page">ุงูุฃุฏูุงุช ุงููุฏุฑุณูุฉ</a>
        </nav>

        <div class="header__actions">
          <button class="iconBtn hamb" id="hambBtn" aria-label="ุงููุงุฆูุฉ">
            โฐ
          </button>

          <button class="btn btn--ghost" id="accountBtn" type="button">
            ๐ค ุญุณุงุจ
          </button>
        </div>
      </div>

      <!-- Mobile Nav -->
      <div class="container mobileNav is-hidden" id="mobileNav">
        <a href="index.html#releases">ุงูุฅุตุฏุงุฑุงุช</a>
        <a href="index.html#videos">ููุฏูู</a>
        <a href="index.html#contact">ุชูุงุตู</a>
        <a href="school.html">ุงูุฃุฏูุงุช ุงููุฏุฑุณูุฉ</a>
      </div>

      <!-- Cart Floating Button -->
      <button class="cartBtn" id="cartBtn" aria-label="ุณูุฉ ุงููุดุชุฑูุงุช">
        ๐
        <span class="cartCount" id="cartCount">0</span>
      </button>
    </header>

    <!-- HERO -->
    <section class="section schoolHero">
      <div class="container">
        <div class="schoolHero__card">
          <div class="schoolHero__txt">
            <h1>ุงูุฃุฏูุงุช ุงููุฏุฑุณูุฉ</h1>
            <p class="muted" style="line-height: 1.9; margin: 0">
              <strong>ูุคุณุณุฉ ุงููุฑุฏูุณ</strong> โ ุงูููุตุฉ ุงูุฑุณููุฉ ุงููุชุฎุตุตุฉ ูู ุชูููุฑ
              ุฌููุน ุงูุฃุฏูุงุช ุงููุฏุฑุณูุฉ ูุงููุณุชูุฒูุงุช ุงูุชุนููููุฉ ุจุฌูุฏุฉ ูุนุชูุฏุฉ ูุชููุน
              ุดุงูู ูุฎุฏู ุฌููุน ุงููุฑุงุญู ุงูุฏุฑุงุณูุฉ.
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Shop -->
    <section class="section schoolShop">
      <div class="container">
        <div class="shopBar">
          <div class="shopSearch" role="search">
            <span class="shopSearch__icon" aria-hidden="true">๐</span>
            <input
              id="q"
              class="shopSearch__input"
              type="search"
              placeholder="ุงุจุญุซ: ููู โ ุดูุทุฉ โ ูุดููู โ ูุณุทุฑุฉ..."
              autocomplete="off"
            />
            <button class="btn btn--primary" id="searchBtn" type="button">
              ุจุญุซ
            </button>
          </div>

          <div class="shopTools">
            <select id="sort" class="select shopSelect" aria-label="ุชุฑุชูุจ">
              <option value="popular">ุงูุฃูุซุฑ ูุจูุนูุง</option>
              <option value="rate">ุงูุฃุนูู ุชูููููุง</option>
              <option value="priceAsc">ุงูุณุนุฑ: ูู ุงูุฃูู</option>
              <option value="priceDesc">ุงูุณุนุฑ: ูู ุงูุฃุนูู</option>
            </select>

            <button class="btn btn--ghost" id="clearBtn" type="button">
              ูุณุญ ุงูููุงุชุฑ
            </button>
          </div>
        </div>

        <div class="chipRow" id="chipRow" aria-label="ุงูุชุตูููุงุช">
          <button class="chip chipBtn is-active" data-cat="all" type="button">
            ุงููู
          </button>
          <button class="chip chipBtn" data-cat="pens" type="button">
            ุฃููุงู
          </button>
          <button class="chip chipBtn" data-cat="notebooks" type="button">
            ูุดุงููู
          </button>
          <button class="chip chipBtn" data-cat="bags" type="button">
            ุดูุท
          </button>
          <button class="chip chipBtn" data-cat="tools" type="button">
            ุฃุฏูุงุช ููุฏุณูุฉ
          </button>
        </div>

        <div class="resultsHead" aria-live="polite">
          <strong id="resultsCount">0</strong>
          <span class="muted">ููุชุฌ</span>
          <span class="muted" id="smartHint" style="margin-inline-start: 10px"
            >โข ุจุญุซ ุฐูู ููุนูู</span
          >
        </div>

        <div class="shopGrid" id="grid"></div>
      </div>
    </section>

    <!-- Product View -->
    <div class="productView" id="productView" aria-hidden="true">
      <div class="productView__panel" role="dialog" aria-label="ุชูุงุตูู ุงูููุชุฌ">
        <button class="backBtn" id="closeProduct" aria-label="ุฑุฌูุน">โ</button>

        <div class="productView__media">
          <img id="pvImg" src="" alt="" />
        </div>

        <div class="productView__info">
          <h2 id="pvTitle"></h2>
          <p class="muted" id="pvDesc"></p>

          <div class="pvPrice"><strong id="pvPrice"></strong> ุฌููู</div>

          <div style="display: flex; gap: 10px; flex-wrap: wrap">
            <button class="btn btn--primary" id="pvAdd">ุฅุถุงูุฉ ุฅูู ุงูุณูุฉ</button>
            <button class="btn btn--ghost" id="pvBuyNow">ุดุฑุงุก ุงูุขู</button>
          </div>

          <p class="muted small" style="margin-top: 10px; line-height: 1.8">
            * ุงูุณูุฉ ูุญููุธุฉ ุชููุงุฆููุง โข ููููู ุฅุชูุงู ุงูุทูุจ ูู ุตูุญุฉ Checkout ุฃู
            ูุงุชุณุงุจ.
          </p>
        </div>
      </div>
    </div>

    <!-- Cart Drawer -->
    <div class="cartDrawer" id="cartDrawer" aria-hidden="true">
      <div class="cartDrawer__panel" role="dialog" aria-label="ุณูุฉ ุงููุดุชุฑูุงุช">
        <header class="cartDrawer__head">
          <strong>ุณูุฉ ุงููุดุชุฑูุงุช</strong>
          <button
            class="iconBtn"
            id="closeCart"
            type="button"
            aria-label="ุฅุบูุงู"
          >
            โ
          </button>
        </header>

        <div class="cartDrawer__items" id="cartItems"></div>

        <footer class="cartDrawer__footer">
          <div class="cartTotal">
            <span>ุงูุฅุฌูุงูู</span>
            <span><strong id="cartTotal">0</strong> ุฌููู</span>
          </div>

          <div class="cartActions">
            <a class="btn btn--primary" href="checkout.html" id="toCheckout">
              โ ุฅุชูุงู ุงูุทูุจ
            </a>

            <button class="btn btn--ghost" id="sendWA" type="button">
              ๐ฒ ุฅุฑุณุงู ุงูุทูุจ ูุงุชุณุงุจ
            </button>

            <button class="btn btn--ghost" id="clearCart" type="button">
              ๐งน ุชูุฑูุบ ุงูุณูุฉ
            </button>
          </div>
        </footer>
      </div>
    </div>

    <!-- Account Modal -->
    <div class="modal" id="accountModal" aria-hidden="true">
      <div class="modal__backdrop" data-close-account></div>
      <div class="modal__panel">
        <div class="modal__head">
          <h3>ุงูุญุณุงุจ</h3>
          <button class="iconBtn" data-close-account type="button">โ</button>
        </div>
        <div class="modal__body">
          <div style="display: grid; gap: 10px">
            <div class="muted">ุงุญูุธ ุจูุงูุงุชู ูุชุณุฑูุน ุงูู Checkout:</div>
            <div
              class="fields"
              style="grid-template-columns: 1fr; margin-top: 0"
            >
              <div class="field">
                <label>ุงูุงุณู</label>
                <input class="input" id="accName" placeholder="ุงุณูู" />
              </div>
              <div class="field">
                <label>ุงููุงุชู/ูุงุชุณุงุจ</label>
                <input class="input" id="accPhone" placeholder="01xxxxxxxxx" />
              </div>
              <div class="field">
                <label>ุงููุฏููุฉ/ุงูุนููุงู</label>
                <input
                  class="input"
                  id="accAddress"
                  placeholder="ูุซุงู: ุงูุฅุณููุฏุฑูุฉโฆ"
                />
              </div>
            </div>
            <div
              style="
                display: flex;
                gap: 10px;
                justify-content: flex-end;
                flex-wrap: wrap;
              "
            >
              <button class="btn btn--ghost" data-close-account type="button">
                ุฅูุบุงุก
              </button>
              <button class="btn btn--primary" id="saveAccount" type="button">
                ุญูุธ
              </button>
            </div>
            <div class="muted small" id="accSavedHint" style="display: none">
              โ ุชู ุงูุญูุธ
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      /* =======================
         SETTINGS
      ======================= */
      const SETTINGS = {
        currency: "ุฌููู",
        adminWhatsApp: "201000051078", // ุฑูู ุฏููู ุจุฏูู +
        storeName: "ูุคุณุณุฉ ุงููุฑุฏูุณ โ ุงูุฃุฏูุงุช ุงููุฏุฑุณูุฉ",
      };

      /* =======================
         Mobile Menu
      ======================= */
      const hambBtn = document.getElementById("hambBtn");
      const mobileNav = document.getElementById("mobileNav");
      if (hambBtn && mobileNav) {
        hambBtn.addEventListener("click", () =>
          mobileNav.classList.toggle("is-hidden"),
        );
      }

      /* =======================
         Products
         โ๏ธ ุชู ุฅุตูุงุญ ุชูุฑุงุฑ ID (4 -> 5)
      ======================= */
      const PRODUCTS = [
        {
          id: 1,
          title: "ููู ุฌุงู ุฃุฒุฑู",
          cat: "pens",
          price: 25,
          rate: 4.6,
          reviews: 1200,
          badge: "ุงูุฃูุซุฑ ูุจูุนูุง",
          img: "assets/imge16pen.jpg",
          desc: "ููู ูุชุงุจุฉ ูุงุนู ูุซุงุจุช โ ููุงุณุจ ูููุฏุฑุณุฉ.",
          keywords: ["ููู", "ุฌุงู", "ุงุฒุฑู", "blue", "pen"],
        },
        {
          id: 2,
          title: "ูุดููู 100 ูุฑูุฉ",
          cat: "notebooks",
          price: 45,
          rate: 4.4,

          badge: "ุนุฑุถ",
          img: "assets/imge17book.jpeg",
          desc: "ูุฑู ุฌูุฏ + ุบูุงู ูุชูู โ ููุงุณุจ ูููุฐุงูุฑุฉ.",
          keywords: ["ูุดููู", "ุฏูุชุฑ", "ูุฑู", "notebook"],
        },
        {
          id: 3,
          title: "ุดูุทุฉ ูุฏุฑุณูุฉ",
          cat: "bags",
          price: 399,
          rate: 4.7,

          badge: "ุฌุฏูุฏ",
          img: "assets/imge18bag.jfif",
          desc: "ุฎุงูุฉ ูููุฉ + ูุณุงุญุฉ ูุจูุฑุฉ โ ูุฑูุญุฉ ููุญูู.",
          keywords: ["ุดูุทุฉ", "ุญููุจุฉ", "bag", "ุญุงูุธู"],
        },
        {
          id: 4,
          title: "ุทูู ุฃุฏูุงุช ููุฏุณูุฉ",
          cat: "tools",
          price: 120,
          rate: 4.3,

          badge: "ูููุฒ",
          img: "assets/imge19.jfif",
          desc: "ูุณุทุฑุฉ + ููููุฉ + ุจุฑุฌู โ ุทูู ูุชูุงูู.",
          keywords: ["ูุณุทุฑุฉ", "ููููุฉ", "ุจุฑุฌู", "ููุฏุณุฉ", "tools", "set"],
        },
        {
          id: 5,
          title: "ุทูู ุฃุฏูุงุช ููุฏุณูุฉ (ูุงุฎุฑ)",
          cat: "tools",
          price: 180,
          rate: 4.3,

          badge: "ูููุฒ",
          img: "assets/imge20.jpg",
          desc: "ุทูู ูุงุฎุฑ โ ุฎุงูุฉ ุฃููู ููุญุชูู ุฃูุจุฑ.",
          keywords: ["ูุณุทุฑุฉ", "ููููุฉ", "ุจุฑุฌู", "ููุฏุณุฉ", "tools", "set"],
        },
      ];

      /* =======================
         UI Refs
      ======================= */
      const grid = document.getElementById("grid");
      const q = document.getElementById("q");
      const sort = document.getElementById("sort");
      const resultsCount = document.getElementById("resultsCount");
      const chipRow = document.getElementById("chipRow");

      const productView = document.getElementById("productView");
      const closeProduct = document.getElementById("closeProduct");
      const pvImg = document.getElementById("pvImg");
      const pvTitle = document.getElementById("pvTitle");
      const pvDesc = document.getElementById("pvDesc");
      const pvPrice = document.getElementById("pvPrice");
      const pvAdd = document.getElementById("pvAdd");
      const pvBuyNow = document.getElementById("pvBuyNow");

      const cartBtn = document.getElementById("cartBtn");
      const cartDrawer = document.getElementById("cartDrawer");
      const closeCart = document.getElementById("closeCart");
      const cartItems = document.getElementById("cartItems");
      const cartTotalEl = document.getElementById("cartTotal");
      const cartCountEl = document.getElementById("cartCount");
      const clearCartBtn = document.getElementById("clearCart");
      const sendWA = document.getElementById("sendWA");

      /* =======================
         State
      ======================= */
      let state = { cat: "all", q: "", sort: "popular" };
      let CURRENT_PRODUCT = null;
      let CART = JSON.parse(localStorage.getItem("school_cart") || "[]");

      /* =======================
         Smart Filter (ูุญูู)
      ======================= */
      const AR_MAP = { ุฃ: "ุง", ุฅ: "ุง", ุข: "ุง", ู: "ู", ุฉ: "ู", ุค: "ู", ุฆ: "ู" };
      function normalizeArabic(str) {
        return String(str || "")
          .toLowerCase()
          .trim()
          .replace(/[ุฃุฅุขูุฉุคุฆ]/g, (m) => AR_MAP[m] || m)
          .replace(/[^\p{L}\p{N}\s]+/gu, " ")
          .replace(/\s+/g, " ");
      }

      const SYNONYMS = [
        { keys: ["ููู", "pen"], add: ["ุฌุงู", "ุฑุณู", "ุฑุตุงุต", "ูุงุฑูุฑ", "ุญุจุฑ"] },
        { keys: ["ุฏูุชุฑ", "ูุดููู", "notebook"], add: ["ูุฑู", "ูุฐูุฑุฉ", "notes"] },
        { keys: ["ุดูุทุฉ", "ุญููุจุฉ", "bag"], add: ["ูุฏุฑุณูุฉ", "ุธูุฑ", "ุธูุฑูุฉ"] },
        {
          keys: ["ูุณุทุฑุฉ", "ููุฏุณุฉ", "tools", "set"],
          add: ["ููููุฉ", "ุจุฑุฌู", "ูุซูุซุงุช"],
        },
      ];

      function smartExpand(term) {
        const t = normalizeArabic(term);
        if (!t) return [];
        const tokens = t.split(" ").filter(Boolean);
        const expanded = new Set(tokens);
        SYNONYMS.forEach((s) => {
          const hit = s.keys.some((k) => tokens.includes(normalizeArabic(k)));
          if (hit) s.add.forEach((a) => expanded.add(normalizeArabic(a)));
        });
        return Array.from(expanded);
      }

      function scoreProduct(p, tokens) {
        const hay = normalizeArabic(
          p.title + " " + (p.desc || "") + " " + (p.keywords || []).join(" "),
        );
        let score = 0;
        tokens.forEach((t) => {
          if (!t) return;
          if (hay.includes(t)) score += 3;
          if (hay.split(" ").some((w) => w.startsWith(t))) score += 1;
        });
        score += (p.rate || 0) * 0.2;
        score += Math.min(1, (p.reviews || 0) / 2000) * 0.5;
        return score;
      }

      /* =======================
         UI Helpers
      ======================= */
      function stars(rate) {
        const full = Math.floor(rate);
        const half = rate - full >= 0.5;
        let s = "โ".repeat(full);
        if (half) s += "ยฝ";
        return s;
      }

      function saveCart() {
        localStorage.setItem("school_cart", JSON.stringify(CART));
      }
      function cartCount() {
        return CART.reduce((a, b) => a + (b.qty || 0), 0);
      }
      function cartTotal() {
        return CART.reduce((a, b) => a + (b.qty || 0) * (b.price || 0), 0);
      }

      /* โ FIX: renderCart ุงูุขู ูุทุจุน ุตูุฑุฉ ุงูููุชุฌ ุจุงุณุชุฎุฏุงู item.img
         ููุทุงุจู ูู CSS classes ุนูุฏู
      */
      function renderCart() {
        if (!CART.length) {
          cartItems.innerHTML = `
            <div class="cartEmpty muted">
              ุณูุชู ูุงุฑุบุฉ โ ุฌุฑูุจ ุชุถูู ููุชุฌุงุช ๐
            </div>
          `;
        } else {
          cartItems.innerHTML = CART.map(
            (item, index) => `
            <div class="cartItem" data-row="${index}">
              <div class="cartItem__img">
                <img src="${item.img || ""}" alt="${item.title || ""}" loading="lazy"
                  onerror="this.style.display='none';" />
              </div>

              <div class="cartItem__meta">
                <div class="cartItem__top">
                  <p class="cartItem__title">${item.title}</p>
                  <button class="cartItem__remove" type="button" data-remove="${index}" aria-label="ุญุฐู">โ</button>
                </div>

                <div class="cartItem__bottom">
                  <div class="cartItem__price">
                    <span class="muted">ุงูุณุนุฑ</span>
                    <strong>${Number(item.price || 0).toLocaleString("ar-EG")}</strong>
                    <span class="muted">${SETTINGS.currency}</span>
                  </div>

                  <div class="qty" aria-label="ุงููููุฉ">
                    <button type="button" data-dec="${index}" aria-label="ุชูููู">โ</button>
                    <span>${item.qty}</span>
                    <button type="button" data-inc="${index}" aria-label="ุฒูุงุฏุฉ">+</button>
                  </div>
                </div>
              </div>
            </div>
          `,
          ).join("");
        }

        cartTotalEl.textContent = cartTotal().toLocaleString("ar-EG");
        cartCountEl.textContent = cartCount();
        saveCart();
      }

      function addToCart(product, qty = 1) {
        const found = CART.find((p) => p.id === product.id);
        if (found) found.qty += qty;
        else
          CART.push({
            id: product.id,
            title: product.title,
            price: product.price,
            img: product.img, // โ ุงูุตูุฑุฉ ุชูุญูุธ
            qty: qty,
          });
        renderCart();
      }

      function openCart() {
        cartDrawer.setAttribute("aria-hidden", "false");
      }
      function closeCartDrawer() {
        cartDrawer.setAttribute("aria-hidden", "true");
      }

      function openProduct(product) {
        CURRENT_PRODUCT = product;
        pvImg.src = product.img;
        pvImg.alt = product.title;
        pvTitle.textContent = product.title;
        pvDesc.textContent = product.desc || product.badge || "ููุชุฌ ูุฏุฑุณู ูููุฒ";
        pvPrice.textContent = Number(product.price || 0).toLocaleString(
          "ar-EG",
        );
        productView.setAttribute("aria-hidden", "false");
      }
      function closeProductView() {
        productView.setAttribute("aria-hidden", "true");
      }

      /* =======================
         Render Products
      ======================= */
      function apply() {
        let items = [...PRODUCTS];

        if (state.cat !== "all")
          items = items.filter((p) => p.cat === state.cat);

        const term = state.q.trim();
        if (term) {
          const tokens = smartExpand(term);
          items = items
            .map((p) => ({ p, s: scoreProduct(p, tokens) }))
            .filter((x) => x.s > 0)
            .sort((a, b) => b.s - a.s)
            .map((x) => x.p);
        }

        if (state.sort === "rate")
          items.sort((a, b) => (b.rate || 0) - (a.rate || 0));
        if (state.sort === "priceAsc")
          items.sort((a, b) => (a.price || 0) - (b.price || 0));
        if (state.sort === "priceDesc")
          items.sort((a, b) => (b.price || 0) - (a.price || 0));

        resultsCount.textContent = items.length;

        grid.innerHTML = items
          .map(
            (p) => `
          <article class="pCard" tabindex="0" data-id="${p.id}">
            <div class="pMedia">
              <img src="${p.img}" alt="${p.title}" loading="lazy" />
              <span class="pBadge">${p.badge || "ูููุฒ"}</span>
            </div>

            <div class="pBody">
              <h3 class="pTitle">${p.title}</h3>

              <div class="pRate">
                <span class="pStars">${stars(p.rate || 0)}</span>
                <span class="muted">${(p.rate || 0).toFixed(1)}</span>
                <span class="muted">(${Number(p.reviews || 0).toLocaleString("ar-EG")})</span>
              </div>

              <div class="pPrice">
                <strong>${Number(p.price || 0).toLocaleString("ar-EG")}</strong>
                <span class="muted">${SETTINGS.currency}</span>
              </div>

              <div class="pActions">
                <button class="btn btn--primary" type="button" data-action="add">ุฅุถุงูุฉ ููุณูุฉ</button>
                <button class="btn btn--ghost" type="button" data-action="details">ุชูุงุตูู</button>
              </div>
            </div>
          </article>
        `,
          )
          .join("");
      }

      /* =======================
         Events
      ======================= */
      chipRow.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-cat]");
        if (!btn) return;
        chipRow
          .querySelectorAll(".chipBtn")
          .forEach((b) => b.classList.remove("is-active"));
        btn.classList.add("is-active");
        state.cat = btn.dataset.cat;
        apply();
      });

      document.getElementById("searchBtn").addEventListener("click", () => {
        state.q = q.value;
        apply();
      });

      q.addEventListener("input", () => {
        state.q = q.value;
        apply();
      });

      sort.addEventListener("change", () => {
        state.sort = sort.value;
        apply();
      });

      document.getElementById("clearBtn").addEventListener("click", () => {
        q.value = "";
        state.q = "";
        state.cat = "all";
        state.sort = "popular";
        sort.value = "popular";
        chipRow
          .querySelectorAll(".chipBtn")
          .forEach((b) => b.classList.remove("is-active"));
        chipRow.querySelector('[data-cat="all"]').classList.add("is-active");
        apply();
      });

      grid.addEventListener("click", (e) => {
        const card = e.target.closest(".pCard");
        if (!card) return;
        const id = Number(card.dataset.id);
        const product = PRODUCTS.find((p) => p.id === id);
        if (!product) return;

        const action = e.target.closest("[data-action]")?.dataset.action;
        if (action === "add") {
          addToCart(product, 1);
          openCart();
          return;
        }
        if (action === "details") {
          openProduct(product);
          return;
        }
      });

      grid.addEventListener("keydown", (e) => {
        if (e.key !== "Enter" && e.key !== " ") return;
        const card = e.target.closest(".pCard");
        if (!card) return;
        e.preventDefault();
        const id = Number(card.dataset.id);
        const product = PRODUCTS.find((p) => p.id === id);
        if (product) openProduct(product);
      });

      closeProduct.addEventListener("click", closeProductView);
      productView.addEventListener("click", (e) => {
        if (e.target === productView) closeProductView();
      });

      pvAdd.addEventListener("click", () => {
        if (!CURRENT_PRODUCT) return;
        addToCart(CURRENT_PRODUCT, 1);
        closeProductView();
        openCart();
      });

      pvBuyNow.addEventListener("click", () => {
        if (!CURRENT_PRODUCT) return;
        addToCart(CURRENT_PRODUCT, 1);
        window.location.href = "checkout.html";
      });

      cartBtn.addEventListener("click", openCart);
      closeCart.addEventListener("click", closeCartDrawer);
      cartDrawer.addEventListener("click", (e) => {
        if (e.target === cartDrawer) closeCartDrawer();
      });

      cartItems.addEventListener("click", (e) => {
        const inc = e.target.dataset.inc;
        const dec = e.target.dataset.dec;
        const rem = e.target.dataset.remove;

        if (inc != null) {
          CART[Number(inc)].qty++;
          renderCart();
          return;
        }
        if (dec != null) {
          CART[Number(dec)].qty--;
          if (CART[Number(dec)].qty <= 0) CART.splice(Number(dec), 1);
          renderCart();
          return;
        }
        if (rem != null) {
          CART.splice(Number(rem), 1);
          renderCart();
          return;
        }
      });

      clearCartBtn.addEventListener("click", () => {
        CART = [];
        renderCart();
      });

      function buildOrderText() {
        const profile = JSON.parse(
          localStorage.getItem("school_profile") || "{}",
        );
        const lines = [];
        lines.push(`๐ ุทูุจ ุฌุฏูุฏ โ ${SETTINGS.storeName}`);
        lines.push("โ");
        if (profile.name) lines.push(`ุงูุงุณู: ${profile.name}`);
        if (profile.phone) lines.push(`ุงููุงุชู: ${profile.phone}`);
        if (profile.address) lines.push(`ุงูุนููุงู: ${profile.address}`);
        lines.push("โ");
        lines.push("๐งพ ุงูููุชุฌุงุช:");
        CART.forEach((it) => {
          lines.push(
            `โข ${it.title} ร ${it.qty} = ${(it.qty * it.price).toLocaleString("ar-EG")} ${SETTINGS.currency}`,
          );
        });
        lines.push("โ");
        lines.push(
          `ุงูุฅุฌูุงูู: ${cartTotal().toLocaleString("ar-EG")} ${SETTINGS.currency}`,
        );
        lines.push("โ");
        lines.push("โ ุจุฑุฌุงุก ุชุฃููุฏ ุงูุชููุฑ ูููุช ุงูุชุณููู.");
        return lines.join("\n");
      }

      sendWA.addEventListener("click", () => {
        if (!CART.length) {
          alert("ุงูุณูุฉ ูุงุฑุบุฉ.");
          return;
        }
        const msg = encodeURIComponent(buildOrderText());
        const url = `https://wa.me/${SETTINGS.adminWhatsApp}?text=${msg}`;
        window.open(url, "_blank", "noopener");
      });

      document.addEventListener("keydown", (e) => {
        if (e.key !== "Escape") return;
        closeProductView();
        closeCartDrawer();
        closeAccountModal();
      });

      /* =======================
         Account Modal
      ======================= */
      const accountBtn = document.getElementById("accountBtn");
      const accountModal = document.getElementById("accountModal");
      const accName = document.getElementById("accName");
      const accPhone = document.getElementById("accPhone");
      const accAddress = document.getElementById("accAddress");
      const saveAccount = document.getElementById("saveAccount");
      const accSavedHint = document.getElementById("accSavedHint");

      function openAccountModal() {
        const profile = JSON.parse(
          localStorage.getItem("school_profile") || "{}",
        );
        accName.value = profile.name || "";
        accPhone.value = profile.phone || "";
        accAddress.value = profile.address || "";
        accountModal.setAttribute("aria-hidden", "false");
      }
      function closeAccountModal() {
        accountModal.setAttribute("aria-hidden", "true");
      }

      accountBtn.addEventListener("click", openAccountModal);
      accountModal.addEventListener("click", (e) => {
        if (
          e.target.hasAttribute("data-close-account") ||
          e.target === accountModal
        )
          closeAccountModal();
      });
      accountModal.querySelectorAll("[data-close-account]").forEach((x) => {
        x.addEventListener("click", closeAccountModal);
      });

      saveAccount.addEventListener("click", () => {
        const profile = {
          name: accName.value.trim(),
          phone: accPhone.value.trim(),
          address: accAddress.value.trim(),
        };
        localStorage.setItem("school_profile", JSON.stringify(profile));
        accSavedHint.style.display = "block";
        setTimeout(() => (accSavedHint.style.display = "none"), 1200);
      });

      /* =======================
         Boot
      ======================= */
      apply();
      renderCart();

      /* =======================
         PWA Service Worker
         โ ุชู ุญุฐู ุงูุชูุฑุงุฑ ูุชุตุญูุญ ุงูุณุทุฑ
      ======================= */
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("./sw.js", { scope: "./" })
            .catch(() => {});
        });
      }
    </script>
  </body>
</html>
