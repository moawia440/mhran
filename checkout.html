<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#0B0820" />
    <title>ุฅุชูุงู ุงูุทูุจ</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800;900&display=swap" rel="stylesheet" />

    <link rel="stylesheet" href="style.css" />

    <style>
      .receiptPreview{margin-top:12px;border:1px solid rgba(255,255,255,.08);border-radius:14px;overflow:hidden;background:#0b0820}
      .receiptPreview img{display:block;width:100%;height:auto}
      .receiptBox{border:1px dashed rgba(255,215,0,.35);padding:12px;border-radius:16px;background:rgba(255,215,0,.06)}
    </style>

  </head>

  <body>
    <header class="header" id="top">
      <div class="container header__row">
        <a class="brand" href="school.html" aria-label="ุฑุฌูุน ููุฃุฏูุงุช ุงููุฏุฑุณูุฉ">
          <span class="brand__logo" aria-hidden="true"></span>
          <span class="brand__txt">
            <strong>Checkout</strong>
            <em>ุฅุชูุงู ุงูุทูุจ</em>
          </span>
        </a>

        <div class="header__actions">
          <a class="btn btn--ghost" href="school.html">โ ุฑุฌูุน</a>
        </div>
      </div>
    </header>

    <main class="section">
      <div class="container">
        <div class="quoteLayout" style="grid-template-columns: 1.05fr 0.95fr">
          <form class="card" id="checkoutForm">
            <div class="card__head">
              <h3>ุจูุงูุงุช ุงูุนููู</h3>
              <p>ุงููุฃ ุงูุจูุงูุงุช ูุฅุฑุณุงู ุงูุทูุจ ูุงุชุณุงุจ ุจุดูู ุงุญุชุฑุงูู.</p>
            </div>

            <div class="fields" style="grid-template-columns: 1fr">
              <div class="field">
                <label>ุงูุงุณู *</label>
                <input class="input" id="name" required placeholder="ุงุณูู" />
              </div>

              <div class="field">
                <label>ุงููุงุชู/ูุงุชุณุงุจ *</label>
                <input
                  class="input"
                  id="phone"
                  required
                  placeholder="01xxxxxxxxx"
                />
              </div>

              <div class="field">
                <label>ุงูุนููุงู *</label>
                <input
                  class="input"
                  id="address"
                  required
                  placeholder="ูุซุงู: ุงูุฅุณููุฏุฑูุฉโฆ"
                />
              </div>

              <div class="field">
                <label>ููุงุญุธุงุช</label>
                <input class="input" id="notes" placeholder="ุฃู ููุงุญุธุงุชโฆ" />
              </div>

              <div class="field">
                <label>ุทุฑููุฉ ุงูุงุณุชูุงู</label>
                <select class="select" id="delivery">
                  <option value="delivery">ุชูุตูู</option>
                  <option value="pickup">ุงุณุชูุงู ูู ุงููุฑุน</option>
                </select>
              </div>
            </div>

            <div class="actions" style="justify-content: flex-start">
              <button class="btn btn--primary" type="submit">
                ๐งพ ุฅูุดุงุก ูุงุชูุฑุฉ ุตูุฑุฉ
              </button>
              <button class="btn btn--ghost" type="button" id="saveProfile">
                ๐พ ุญูุธ ุงูุจูุงูุงุช
              </button>
            </div>


            <div id="receiptBox" class="receiptBox" style="display:none; margin-top:14px">
              <div class="row" style="align-items:flex-start; gap:12px">
                <div style="flex:1">
                  <div class="muted small" style="margin-bottom:8px">
                    โ ุชู ุฅูุดุงุก ูุงุชูุฑุฉ ูุตูุฑุฉ (ูุง ูููู ุชุนุฏูู ุงูุณุนุฑ ูู ุงูุนููู).
                    ุฑูู ุงูุทูุจ: <strong id="orderNoView">โ</strong>
                  </div>
                  <div class="actions" style="justify-content:flex-start; flex-wrap:wrap">
                    <button class="btn btn--primary" type="button" id="btnShareWA">๐ค ูุดุงุฑูุฉ ุงูุตูุฑุฉ (ูุงุชุณุงุจ)</button>
                    <button class="btn btn--ghost" type="button" id="btnDownloadPNG">โฌ๏ธ ุชุญููู ุงูุตูุฑุฉ</button>
                    <button class="btn btn--ghost" type="button" id="btnOpenWA">๐ข ูุชุญ ูุงุชุณุงุจ ููุชุงุจุฉ ุฑุณุงูุฉ ูุตูุฑุฉ</button>
                    <button class="btn btn--ghost" type="button" id="btnFinish">โ ุชู ุงูุฅุฑุณุงู (ุชูุฑูุบ ุงูุณูุฉ)</button>
                  </div>
                </div>
              </div>

              <div class="receiptPreview">
                <img id="receiptImg" alt="ูุงุชูุฑุฉ ุงูุทูุจ" />
              </div>

              <p class="muted small" style="margin-top:10px; line-height:1.8">
                ุนูู ุงููุงุชู: ุฒุฑ <strong>ูุดุงุฑูุฉ ุงูุตูุฑุฉ</strong> ููุชุญ ูุงุฆูุฉ ุงููุดุงุฑูุฉ ูุจุงุดุฑุฉ ูู ุฌูุงุฒู ูุฏุนู ุฐูู.
                ุนูู ุงูููุจููุชุฑ: ุงุณุชุฎุฏู <strong>ุชุญููู ุงูุตูุฑุฉ</strong> ุซู ุฃุฑูููุง ุฏุงุฎู ูุงุชุณุงุจ.
              </p>
            </div>

            <p class="muted small" style="margin-top: 10px; line-height: 1.8">
              * ูุชู ุฅูุดุงุก ูุงุชูุฑุฉ ูุตูุฑุฉ (PNG) ุซู ููููู ูุดุงุฑูุชูุง/ุชุญููููุง ูุฅุฑุณุงููุง ูุฑูู ุงูุฅุฏุงุฑุฉ ุนูู ูุงุชุณุงุจ.
              ููููู ุชุนุฏูู ุงูุฑูู ุฏุงุฎู school.html.
            </p>
          </form>

          <aside class="card">
            <div class="card__head">
              <h3>ููุฎุต ุงูุทูุจ</h3>
              <p>ูุญุชูู ุงูุณูุฉ + ุงูุฅุฌูุงูู.</p>
            </div>

            <div
              id="emptyHint"
              class="muted"
              style="display: none; font-weight: 900"
            >
              ุงูุณูุฉ ูุงุฑุบุฉ โ ุงุฑุฌุน ููุฃุฏูุงุช ุงููุฏุฑุณูุฉ ูุฃุถู ููุชุฌุงุช.
            </div>

            <div id="list" class="breakdown"></div>

            <div class="row" style="margin-top: 12px">
              <div class="k">ุงูุฅุฌูุงูู</div>
              <div class="v"><strong id="total">0</strong> ุฌููู</div>
            </div>

            <div
              style="
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                margin-top: 12px;
              "
            >
              <a class="btn btn--ghost" href="school.html">ุฅุถุงูุฉ ููุชุฌุงุช</a>
              <button class="btn btn--ghost" type="button" id="clearCart">
                ุชูุฑูุบ ุงูุณูุฉ
              </button>
            </div>
          </aside>
        </div>
      </div>
    </main>

    <script>
      const SETTINGS = {
        currency: "ุฌููู",
        adminWhatsApp: "201000051078", // ููุณ ุงูุฑูู
        storeName: "ูุคุณุณุฉ ุงููุฑุฏูุณ โ ุงูุฃุฏูุงุช ุงููุฏุฑุณูุฉ",
      };

      let CART = JSON.parse(localStorage.getItem("school_cart") || "[]");

      const list = document.getElementById("list");
      const totalEl = document.getElementById("total");
      const emptyHint = document.getElementById("emptyHint");

      function cartTotal() {
        return CART.reduce((a, b) => a + (b.qty || 0) * (b.price || 0), 0);
      }

      function render() {
        if (!CART.length) {
          emptyHint.style.display = "block";
          list.innerHTML = "";
          totalEl.textContent = "0";
          return;
        }
        emptyHint.style.display = "none";

        list.innerHTML = CART.map(
          (it) => `
          <div class="row">
            <div class="k">${it.title} ร ${it.qty}</div>
            <div class="v">${(it.qty * it.price).toLocaleString("ar-EG")} ${SETTINGS.currency}</div>
          </div>
        `,
        ).join("");

        totalEl.textContent = cartTotal().toLocaleString("ar-EG");
      }

      function normalizePhone(phone) {
        const digits = String(phone || "").replace(/\D/g, "");
        if (digits.length < 8) return null;
        // ูู ุจุฏุฃ ุจู 0 ุงุนุชุจุฑ ูุตุฑ
        if (digits.startsWith("0")) return "20" + digits.slice(1);
        return digits;
      }

      function buildOrderText(profile) {
        const lines = [];
        lines.push(`๐ ุทูุจ ุฌุฏูุฏ โ ${SETTINGS.storeName}`);
        lines.push("โ");
        lines.push(`ุงูุงุณู: ${profile.name}`);
        lines.push(`ุงููุงุชู: ${profile.phone}`);
        lines.push(`ุงูุนููุงู: ${profile.address}`);
        lines.push(
          `ุทุฑููุฉ ุงูุงุณุชูุงู: ${profile.delivery === "pickup" ? "ุงุณุชูุงู ูู ุงููุฑุน" : "ุชูุตูู"}`,
        );
        if (profile.notes) lines.push(`ููุงุญุธุงุช: ${profile.notes}`);
        lines.push("โ");
        lines.push("๐งพ ุงูููุชุฌุงุช:");
        CART.forEach((it) => {
          lines.push(
            `โข ${it.title} ร ${it.qty} = ${(it.qty * it.price).toLocaleString("ar-EG")} ${SETTINGS.currency}`,
          );
        });
        lines.push("โ");
        lines.push(
          `ุงูุฅุฌูุงูู: ${cartTotal().toLocaleString("ar-EG")} ${SETTINGS.currency}`,
        );
        lines.push("โ");
        lines.push("โ ุจุฑุฌุงุก ุชุฃููุฏ ุงูุชููุฑ ูููุช ุงูุชุณููู.");
        return lines.join("\n");
      }

      // Prefill from saved profile
      const saved = JSON.parse(localStorage.getItem("school_profile") || "{}");
      document.getElementById("name").value = saved.name || "";
      document.getElementById("phone").value = saved.phone || "";
      document.getElementById("address").value = saved.address || "";

      document.getElementById("saveProfile").addEventListener("click", () => {
        const profile = {
          name: document.getElementById("name").value.trim(),
          phone: document.getElementById("phone").value.trim(),
          address: document.getElementById("address").value.trim(),
        };
        localStorage.setItem("school_profile", JSON.stringify(profile));
        alert("ุชู ุญูุธ ุงูุจูุงูุงุช โ");
      });

      document.getElementById("clearCart").addEventListener("click", () => {
        CART = [];
        localStorage.setItem("school_cart", "[]");
        render();
      });

      
      // =======================
      // Order Serial (Auto Increment)
      // =======================
      function nextOrderSeq() {
        const key = "school_order_seq";
        const n = Number(localStorage.getItem(key) || "0") + 1;
        localStorage.setItem(key, String(n));
        return n;
      }
      function orderNoLabel(n) {
        return String(n).padStart(4, "0");
      }

      // =======================
      // Receipt as Image (PNG)
      // =======================
      function drawReceiptToCanvas(order) {
        const dpr = Math.max(1, window.devicePixelRatio || 1);
        const W = 860; // logical px
        const pad = 42;
        const lineH = 34;

        const lines = [];
        lines.push({ t: SETTINGS.storeName, s: 34, w: 900 });
        lines.push({ t: "ูุงุชูุฑุฉ ุทูุจ", s: 26, w: 800 });
        lines.push({ t: `ุฑูู ุงูุทูุจ: ${order.orderNo}`, s: 22, w: 800 });
        lines.push({ t: `ุงูุชุงุฑูุฎ: ${order.date}`, s: 18, w: 600 });
        lines.push({ t: "โ", s: 18, w: 400 });

        lines.push({ t: `ุงูุงุณู: ${order.name}`, s: 20, w: 600 });
        lines.push({ t: `ุงููุงุชู: ${order.phone}`, s: 20, w: 600 });
        lines.push({ t: `ุงูุนููุงู: ${order.address}`, s: 20, w: 600 });
        lines.push({
          t: `ุทุฑููุฉ ุงูุงุณุชูุงู: ${order.delivery === "pickup" ? "ุงุณุชูุงู ูู ุงููุฑุน" : "ุชูุตูู"}`,
          s: 20,
          w: 600,
        });
        if (order.notes) lines.push({ t: `ููุงุญุธุงุช: ${order.notes}`, s: 18, w: 600 });

        lines.push({ t: "โ", s: 18, w: 400 });
        lines.push({ t: "ุงูููุชุฌุงุช:", s: 22, w: 800 });

        order.items.forEach((it) => {
          const row = `โข ${it.title} ร ${it.qty} = ${(it.qty * it.price).toLocaleString("ar-EG")} ${SETTINGS.currency}`;
          lines.push({ t: row, s: 20, w: 600 });
        });

        lines.push({ t: "โ", s: 18, w: 400 });
        lines.push({
          t: `ุงูุฅุฌูุงูู: ${order.total.toLocaleString("ar-EG")} ${SETTINGS.currency}`,
          s: 26,
          w: 900,
        });
        lines.push({ t: "โ ุจุฑุฌุงุก ุชุฃููุฏ ุงูุชููุฑ ูููุช ุงูุชุณููู.", s: 18, w: 600 });

        // Height calculation (simple)
        let H = pad * 2 + lines.length * lineH + 120;

        const canvas = document.createElement("canvas");
        canvas.width = Math.round(W * dpr);
        canvas.height = Math.round(H * dpr);
        canvas.style.width = W + "px";
        canvas.style.height = H + "px";

        const ctx = canvas.getContext("2d");
        ctx.scale(dpr, dpr);

        // Background
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, W, H);

        // Header bar
        ctx.fillStyle = "#0B0820";
        ctx.fillRect(0, 0, W, 90);
        ctx.fillStyle = "#FFD24A";
        ctx.fillRect(0, 86, W, 4);

        // Fonts
        ctx.direction = "rtl";
        ctx.textAlign = "right";
        ctx.textBaseline = "top";
        ctx.fillStyle = "#ffffff";
        ctx.font = "900 30px Cairo, system-ui, sans-serif";
        ctx.fillText(SETTINGS.storeName, W - pad, 22);

        // Body
        let y = 110;
        for (const ln of lines.slice(1)) {
          if (ln.t === "โ") {
            ctx.strokeStyle = "rgba(11,8,32,.15)";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(pad, y + 18);
            ctx.lineTo(W - pad, y + 18);
            ctx.stroke();
            y += 18;
            continue;
          }

          const weight = ln.w >= 800 ? "800" : ln.w >= 600 ? "600" : "400";
          ctx.fillStyle = ln.w >= 800 ? "#0B0820" : "#1b1b1b";
          ctx.font = `${weight} ${ln.s}px Cairo, system-ui, sans-serif`;
          // Simple wrapping
          const maxW = W - pad * 2;
          const words = String(ln.t).split(" ");
          let line = "";
          for (let i = 0; i < words.length; i++) {
            const test = (line ? line + " " : "") + words[i];
            const m = ctx.measureText(test);
            if (m.width > maxW && line) {
              ctx.fillText(line, W - pad, y);
              y += lineH;
              line = words[i];
            } else {
              line = test;
            }
          }
          if (line) {
            ctx.fillText(line, W - pad, y);
            y += lineH;
          }
        }

        // Footer
        ctx.fillStyle = "rgba(11,8,32,.06)";
        ctx.fillRect(0, H - 70, W, 70);
        ctx.fillStyle = "#0B0820";
        ctx.font = "700 16px Cairo, system-ui, sans-serif";
        ctx.fillText("ูุฐู ุงููุงุชูุฑุฉ ุตุงุฏุฑุฉ ูู ูููุน ูุคุณุณุฉ ุงููุฑุฏูุณ โ ุฃุฏูุงุช ูุฏุฑุณูุฉ", W - pad, H - 48);

        return canvas;
      }

      function canvasToBlob(canvas) {
        return new Promise((resolve) => {
          canvas.toBlob((b) => resolve(b), "image/png", 1.0);
        });
      }

      let CURRENT_ORDER = null;
      let CURRENT_BLOB = null;
      let CURRENT_URL = null;

      function showReceiptUI(orderNo) {
        document.getElementById("orderNoView").textContent = orderNo;
        document.getElementById("receiptBox").style.display = "block";
        document.getElementById("receiptBox").scrollIntoView({ behavior: "smooth", block: "start" });
      }

      async function makeReceipt(order) {
        const canvas = drawReceiptToCanvas(order);
        const blob = await canvasToBlob(canvas);
        const url = URL.createObjectURL(blob);
        CURRENT_ORDER = order;
        CURRENT_BLOB = blob;
        CURRENT_URL = url;
        document.getElementById("receiptImg").src = url;
        showReceiptUI(order.orderNo);
      }

      function downloadReceipt() {
        if (!CURRENT_BLOB) return alert("ูุง ุชูุฌุฏ ูุงุชูุฑุฉ ุจุนุฏ.");
        const a = document.createElement("a");
        a.href = CURRENT_URL;
        a.download = `order-${CURRENT_ORDER.orderNo}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      async function shareReceiptToWhatsApp() {
        if (!CURRENT_BLOB) return alert("ูุง ุชูุฌุฏ ูุงุชูุฑุฉ ุจุนุฏ.");
        const file = new File([CURRENT_BLOB], `order-${CURRENT_ORDER.orderNo}.png`, { type: "image/png" });

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
          try {
            await navigator.share({
              files: [file],
              title: `ุทูุจ ุฑูู ${CURRENT_ORDER.orderNo}`,
              text: `ุทูุจ ุฌุฏูุฏ โ ุฑูู ${CURRENT_ORDER.orderNo}`,
            });
            return;
          } catch (e) {
            // fallthrough to download + WA
          }
        }

        // Fallback
        downloadReceipt();
        openWhatsAppShortText();
      }

      function openWhatsAppShortText() {
        if (!CURRENT_ORDER) return alert("ูุง ุชูุฌุฏ ุจูุงูุงุช ุทูุจ ุจุนุฏ.");
        const admin = SETTINGS.adminWhatsApp;

        const shortLines = [];
        shortLines.push(`๐งพ ุทูุจ ุฌุฏูุฏ โ ${SETTINGS.storeName}`);
        shortLines.push(`ุฑูู ุงูุทูุจ: ${CURRENT_ORDER.orderNo}`);
        shortLines.push(`ุงูุงุณู: ${CURRENT_ORDER.name}`);
        shortLines.push(`ุงููุงุชู: ${CURRENT_ORDER.phone}`);
        shortLines.push(`ุทุฑููุฉ ุงูุงุณุชูุงู: ${CURRENT_ORDER.delivery === "pickup" ? "ุงุณุชูุงู ูู ุงููุฑุน" : "ุชูุตูู"}`);
        shortLines.push("โ");
        shortLines.push("๐ *ุฃุฑููุช ูุงุชูุฑุฉ ุตูุฑุฉ ููุทูุจ* (ูู ูุถูู ุฃุฑุณู ุงูุตูุฑุฉ).");

        const msg = encodeURIComponent(shortLines.join("\n"));
        const url = `https://wa.me/${admin}?text=${msg}`;
        window.open(url, "_blank", "noopener");
      }

      function finishAndClear() {
        if (!CURRENT_ORDER) return alert("ุงุนูู ุฅูุดุงุก ูุงุชูุฑุฉ ุฃููุงู.");
        CART = [];
        localStorage.setItem("school_cart", "[]");
        render();
        alert("ุชู ุชูุฑูุบ ุงูุณูุฉ โ");
      }

      document.getElementById("btnDownloadPNG").addEventListener("click", downloadReceipt);
      document.getElementById("btnOpenWA").addEventListener("click", openWhatsAppShortText);
      document.getElementById("btnShareWA").addEventListener("click", shareReceiptToWhatsApp);
      document.getElementById("btnFinish").addEventListener("click", finishAndClear);

      // =======================
      // Submit: Create Receipt Image (No editable text)
      // =======================
      document
        .getElementById("checkoutForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!CART.length) {
            alert("ุงูุณูุฉ ูุงุฑุบุฉ.");
            return;
          }

          const name = document.getElementById("name").value.trim();
          const phone = document.getElementById("phone").value.trim();
          const address = document.getElementById("address").value.trim();
          const notes = document.getElementById("notes").value.trim();
          const delivery = document.getElementById("delivery").value;

          if (name.length < 2) return alert("ุงูุชุจ ุงูุงุณู ุจุดูู ุตุญูุญ.");
          if (phone.length < 8) return alert("ุงูุชุจ ุฑูู ูุงุชู ุตุญูุญ.");
          if (address.length < 3) return alert("ุงูุชุจ ุงูุนููุงู.");

          // save profile
          localStorage.setItem("school_profile", JSON.stringify({ name, phone, address }));

          const seq = nextOrderSeq();
          const orderNo = orderNoLabel(seq);
          const dt = new Date();
          const dateStr = dt.toLocaleString("ar-EG");

          const order = {
            orderNo,
            date: dateStr,
            name,
            phone,
            address,
            notes,
            delivery,
            items: CART.map((x) => ({ title: x.title, qty: x.qty, price: x.price })),
            total: cartTotal(),
          };

          await makeReceipt(order);

          // Optional: open WA with short text immediately (you still attach the image manually on desktop)
          // openWhatsAppShortText();
        });


      render();
    </script>
  </body>
</html>
